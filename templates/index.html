<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkToEBM - An√°lise de Evas√£o UPE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .feature-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
        }
        .result-area {
            min-height: 200px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .custom-prompt {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Cabe√ßalho -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4 text-center">üéì TalkToEBM - An√°lise de Evas√£o UPE</h1>
                <p class="lead text-center">Interface web para an√°lise de modelos EBM com linguagem natural</p>
                
                <div class="alert alert-info" role="alert">
                    <strong>Status:</strong> 
                    <span id="status-indicator">
                        {% if model_loaded %}
                            <span class="badge bg-success">Modelo Carregado</span> 
                            {{ feature_names|length }} features dispon√≠veis
                        {% else %}
                            <span class="badge bg-danger">Modelo N√£o Carregado</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Painel de Features -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìä Features Dispon√≠veis</h5>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <div id="features-list">
                            {% for feat in features_with_desc %}
                            <div class="card feature-card mb-2" onclick="describeFeature({{ loop.index0 }})" 
                                 data-bs-toggle="tooltip" data-bs-placement="right" 
                                 title="{{ feat.description }}">
                                <div class="card-body py-2">
                                    <small class="text-muted">#{{ loop.index0 }}</small>
                                    <h6 class="card-title mb-1">{{ feat.name }}</h6>
                                    <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.2;">
                                        {{ feat.description[:80] }}{% if feat.description|length > 80 %}...{% endif %}
                                    </small>
                                    <span class="badge bg-secondary mt-1">
                                        {% if 'Curso' in feat.name or 'Semestre' in feat.name %}
                                            Categ√≥rica
                                        {% else %}
                                            Num√©rica
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Prompt Customizado -->
                <div class="card mt-3 custom-prompt">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üí¨ Prompt Customizado</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="custom-prompt" class="form-label">Instru√ß√£o Personalizada:</label>
                            <textarea class="form-control" id="custom-prompt" rows="3" 
                                      placeholder="Ex: Explique os padr√µes mais surpreendentes neste gr√°fico..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="model-select" class="form-label">Modelo LLM:</label>
                            <select class="form-select" id="model-select">
                                <option value="deepseek-chat">DeepSeek Chat</option>
                                <option value="gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
                                <option value="gpt-4">OpenAI GPT-4</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="language-select" class="form-label">Idioma:</label>
                            <select class="form-select" id="language-select">
                                <option value="Portuguese (Brazil)">Portugu√™s (Brasil)</option>
                                <option value="English">English</option>
                                <option value="Spanish">Espa√±ol</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100 mb-2" onclick="describeModel()">
                            üìà Analisar Modelo Completo
                        </button>
                    </div>
                </div>
            </div>

            <!-- √Årea de Resultados -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">üìù Resultados da An√°lise</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard(event)">
                            üìã Copiar
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Loading -->
                        <div id="loading" class="loading text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2" id="loading-text">Processando sua solicita√ß√£o com o LLM...</p>
                            <div id="progress-info" class="mt-3" style="display: none;">
                                <div class="progress mb-2">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="progress-text" class="text-muted"></small>
                            </div>
                        </div>

                        <!-- Resultado -->
                        <div id="result-area" class="result-area p-3 border rounded">
                            <div class="text-muted text-center py-5">
                                <p>Selecione uma feature ou use um prompt customizado para come√ßar a an√°lise.</p>
                                <small>O LLM ir√° descrever os padr√µes encontrados no modelo EBM.</small>
                            </div>
                        </div>

                        <!-- Informa√ß√µes do Resultado -->
                        <div id="result-info" class="mt-3" style="display: none;">
                            <div class="alert alert-light border" role="alert">
                                <small>
                                    <strong>Feature analisada:</strong> <span id="feature-name">-</span><br>
                                    <strong>Tempo de processamento:</strong> <span id="processing-time">-</span><br>
                                    <strong>Modelo LLM:</strong> <span id="model-name">-</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exemplos de Prompts -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">üí° Exemplos de Prompts</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2" 
                                        onclick="setPrompt('Quais s√£o os padr√µes mais surpreendentes nesta feature?')">
                                    üéØ Padr√µes Surpreendentes
                                </button>
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
                                        onclick="setPrompt('Explique esta an√°lise para um gestor educacional.')">
                                    üë®‚Äçüíº Para Gestores
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
                                        onclick="setPrompt('Quais a√ß√µes pr√°ticas podem ser tomadas baseadas nesta an√°lise?')">
                                    üöÄ A√ß√µes Pr√°ticas
                                </button>
                                <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
                                        onclick="setPrompt('Identifique poss√≠veis vieses ou limita√ß√µes nesta an√°lise.')">
                                    üîç An√°lise Cr√≠tica
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualiza√ß√µes do Modelo -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìä Visualiza√ß√µes do Modelo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <button class="btn btn-success w-100 mb-2" onclick="showGlobalVisualization()">
                                    üåê Visualiza√ß√£o Global do Modelo
                                </button>
                                <small class="text-muted">Mostra o modelo EBM completo com todas as features</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>üìà Visualiza√ß√£o por Feature</h6>
                                <div class="input-group mb-2">
                                    <select class="form-select" id="feature-select" onchange="updateFeatureDescription()">
                                        {% for feat in features_with_desc %}
                                        <option value="{{ feat.name }}" data-description="{{ feat.description }}">{{ feat.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-primary" onclick="showFeatureVisualization()">
                                        Visualizar
                                    </button>
                                </div>
                                <small id="feature-description" class="text-muted d-block">
                                    {% if features_with_desc %}
                                    {{ features_with_desc[0].description }}
                                    {% else %}
                                    Selecione uma feature para visualizar seu gr√°fico de contribui√ß√£o
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>üë§ Explica√ß√µes Locais</h6>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="showLocalVisualization(0)">Amostra 1</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showLocalVisualization(1)">Amostra 2</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showLocalVisualization(2)">Amostra 3</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showLocalVisualization(3)">Amostra 4</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showLocalVisualization(4)">Amostra 5</button>
                                </div>
                                <small class="text-muted">Explica√ß√µes individuais para as primeiras 5 amostras de teste</small>
                            </div>
                        </div>

                        <!-- √Årea de Visualiza√ß√£o -->
                        <div id="visualization-area" class="mt-3" style="display: none;">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">Visualiza√ß√£o</h6>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="hideVisualization()">
                                        ‚úï Fechar
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <iframe id="visualization-frame" style="width: 100%; height: 600px; border: none;"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFeatureIndex = null;

        function setPrompt(text) {
            document.getElementById('custom-prompt').value = text;
        }

        function describeFeature(featureIndex) {
            currentFeatureIndex = featureIndex;
            const customPrompt = document.getElementById('custom-prompt').value;
            const language = document.getElementById('language-select').value;
            const model = document.getElementById('model-select').value;
            
            showLoading();
            
            fetch('/api/describe_graph', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    feature_index: featureIndex,
                    custom_prompt: customPrompt,
                    language: language,
                    model: model
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displayResult(data.description, data.feature_name, model);
                } else {
                    displayError(data.error || 'Erro desconhecido');
                }
            })
            .catch(error => {
                hideLoading();
                displayError('Erro de conex√£o: ' + error.message);
            });
        }

        function describeModel() {
            const customPrompt = document.getElementById('custom-prompt').value;
            const language = document.getElementById('language-select').value;
            const model = document.getElementById('model-select').value;
            
            showLoading();
            
            fetch('/api/describe_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    custom_prompt: customPrompt,
                    language: language,
                    model: model
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displayResult(data.description, 'Modelo Completo', model);
                } else {
                    displayError(data.error || 'Erro desconhecido');
                }
            })
            .catch(error => {
                hideLoading();
                displayError('Erro de conex√£o: ' + error.message);
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('result-info').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('result-info').style.display = 'block';
        }

        function displayResult(text, featureName, model) {
            const resultArea = document.getElementById('result-area');
            const featureNameElement = document.getElementById('feature-name');
            const processingTimeElement = document.getElementById('processing-time');
            const modelElement = document.getElementById('model-name');
            
            resultArea.innerHTML = `<div class="p-3">${text}</div>`;
            featureNameElement.textContent = featureName;
            processingTimeElement.textContent = new Date().toLocaleTimeString();
            modelElement.textContent = getModelDisplayName(model);
            
            // Scroll para o resultado
            resultArea.scrollIntoView({ behavior: 'smooth' });
        }

        function getModelDisplayName(model) {
            const modelNames = {
                'deepseek-chat': 'DeepSeek Chat',
                'gpt-3.5-turbo': 'OpenAI GPT-3.5 Turbo',
                'gpt-4': 'OpenAI GPT-4'
            };
            return modelNames[model] || model;
        }

        function displayError(error) {
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Erro:</strong> ${error}
                </div>
            `;
            document.getElementById('result-info').style.display = 'none';
        }

        function copyToClipboard(event) {
            const resultText = document.getElementById('result-area').innerText;
            navigator.clipboard.writeText(resultText).then(() => {
                // Feedback visual
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copiado!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }

        // Fun√ß√µes para visualiza√ß√µes
        function showGlobalVisualization() {
            const visualizationArea = document.getElementById('visualization-area');
            const visualizationFrame = document.getElementById('visualization-frame');
            
            visualizationFrame.src = '/api/visualize_global';
            visualizationArea.style.display = 'block';
            
            // Scroll para a visualiza√ß√£o
            visualizationArea.scrollIntoView({ behavior: 'smooth' });
        }

        function showFeatureVisualization() {
            const featureSelect = document.getElementById('feature-select');
            const featureName = featureSelect.value;
            const visualizationArea = document.getElementById('visualization-area');
            const visualizationFrame = document.getElementById('visualization-frame');
            
            // Usar encodeURIComponent para lidar com caracteres especiais no nome da feature
            visualizationFrame.src = `/api/visualize_feature_by_name/${encodeURIComponent(featureName)}`;
            visualizationArea.style.display = 'block';
            
            // Scroll para a visualiza√ß√£o
            visualizationArea.scrollIntoView({ behavior: 'smooth' });
        }

        function showLocalVisualization(sampleIndex) {
            const visualizationArea = document.getElementById('visualization-area');
            const visualizationFrame = document.getElementById('visualization-frame');
            
            visualizationFrame.src = `/api/visualize_local/${sampleIndex}`;
            visualizationArea.style.display = 'block';
            
            // Scroll para a visualiza√ß√£o
            visualizationArea.scrollIntoView({ behavior: 'smooth' });
        }

        function hideVisualization() {
            const visualizationArea = document.getElementById('visualization-area');
            const visualizationFrame = document.getElementById('visualization-frame');
            
            visualizationArea.style.display = 'none';
            visualizationFrame.src = '';
        }

        // Fun√ß√£o para atualizar a descri√ß√£o da feature selecionada no dropdown
        function updateFeatureDescription() {
            const featureSelect = document.getElementById('feature-select');
            const selectedOption = featureSelect.options[featureSelect.selectedIndex];
            const description = selectedOption.getAttribute('data-description');
            document.getElementById('feature-description').textContent = description || 'Selecione uma feature';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips do Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Verificar status da API
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    if (!data.model_loaded) {
                        document.getElementById('status-indicator').innerHTML = 
                            '<span class="badge bg-danger">Modelo N√£o Carregado</span>';
                    }
                });
        });
    </script>
</body>
